<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- AFRAME -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <!-- 8th Wall -->
    <script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>

    <script async src="//apps.8thwall.com/xrweb?appKey=2UsfxBeH19YSxWydaVb9kmAJe5oG3og8vd75b2yh4KBdwnlQ86IqV2IMEjMKaV1jJsBmUr"></script>

    <script crossorigin="anonymous"
      src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
      #ui-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 20px;
        transition: opacity .3s ease;
      }
    </style>
  </head>

  <body>

    <!-- UI SCREEN (REQUIRED TO AVOID CRASH) -->
    <div id="ui-screen">
      <div>Point your camera at the imageâ€¦</div>
    </div>

    <a-scene
      xrextras-gesture-detector
      landing-page
      xrextras-loading
      xrextras-runtime-error
      renderer="colorManagement:true; webgl2:true; physicallyCorrectLights:true;"
      xrweb="disableWorldTracking: false">

      <xrextras-person-occlusion confidence="0.9"></xrextras-person-occlusion>
      <a-entity xrextras-scene-mesh="drawOcclusion: true"></a-entity>

      <a-assets>
        <a-asset-item id="anim1" src="../assets/models/anim1.glb"></a-asset-item>
        <a-asset-item id="anim2" src="../assets/models/anim2.glb"></a-asset-item>
        <a-asset-item id="anim3" src="../assets/models/anim3.glb"></a-asset-item>
        <a-asset-item id="anim4" src="../assets/models/anim2.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0"
        raycaster="objects: .cantap"
        cursor="fuse: false; rayOrigin: mouse;"></a-camera>

      <a-light type="directional" intensity="0.5" position="1 1 1"></a-light>
      <a-light type="ambient" intensity="0.7"></a-light>

      <!-- TARGETS --------------------------------------------------- -->

      <xrextras-named-image-target id="chocos1" name="chocos1">
        <a-entity id="anim1-entity" gltf-model="#anim1" visible="false"
          position="0 0 -0" scale="0.7 0.7 0.7"
          animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

        <a-entity id="anim2-entity" gltf-model="#anim2" visible="false"
          position="0 -1 -1" scale="0.7 0.7 0.7"
          animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

        <a-entity id="anim3-entity" gltf-model="#anim3" visible="false"
          position="0 0 0" scale="0.7 0.7 0.7"
          animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

        <a-entity id="anim4-entity" gltf-model="#anim4" visible="false"
          position="0 -1 -1" scale="0.7 0.7 0.7"
          animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

        <a-entity animation-sequence="entities: #anim1-entity, #anim2-entity, #anim3-entity, #anim4-entity"></a-entity>
      </xrextras-named-image-target>
      <xrextras-named-image-target id="moons_stars" name="moons_stars">
    <a-entity
      id="anim1-entity"
      gltf-model="#anim1"
      visible="false"
      position="0 0 -0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="anim2-entity"
      gltf-model="#anim2"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="anim3-entity"
      gltf-model="#anim3"
      visible="false"
      position="0 0 0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>
    <a-entity
      id="anim4-entity"
      gltf-model="#anim4"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      animation-sequence="entities: #anim1-entity, #anim2-entity, #anim3-entity, #anim4-entity"></a-entity>
  </xrextras-named-image-target>

  <xrextras-named-image-target id="doet" name="doet">
    <a-entity
      id="anim1-entity"
      gltf-model="#anim1"
      visible="false"
      position="0 0 -0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="anim2-entity"
      gltf-model="#anim2"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity animation-sequence="entities: #anim1-entity, #anim2-entity"></a-entity>
  </xrextras-named-image-target>
  <xrextras-named-image-target id="chhota_laddoo" name="chhota_laddoo">
    <a-entity
      id="anim1-entity"
      gltf-model="#anim1"
      visible="false"
      position="0 0 -0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="anim2-entity"
      gltf-model="#anim2"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="anim3-entity"
      gltf-model="#anim3"
      visible="false"
      position="0 0 0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>
    <a-entity
      id="anim4-entity"
      gltf-model="#anim4"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      animation-sequence="entities: #anim1-entity, #anim2-entity, #anim3-entity, #anim4-entity"></a-entity>
  </xrextras-named-image-target>
  <xrextras-named-image-target id="crunchy_bites" name="crunchy_bites">
    <a-entity
      id="anim1-entity"
      gltf-model="#anim1"
      visible="false"
      position="0 0 -0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="anim2-entity"
      gltf-model="#anim2"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="anim3-entity"
      gltf-model="#anim3"
      visible="false"
      position="0 0 0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>
    <a-entity
      id="anim4-entity"
      gltf-model="#anim4"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      animation-sequence="entities: #anim1-entity, #anim2-entity, #anim3-entity, #anim4-entity"></a-entity>
  </xrextras-named-image-target>

      <!-- COPY YOUR OTHER TARGETS BELOW (unchanged) -->
      <!-- moons_stars, doet, etcâ€¦ -->

    </a-scene>

    <!-- --------------------------------------------- -->
    <!-- FIXED JAVASCRIPT -->
    <!-- --------------------------------------------- -->

    <script>
AFRAME.registerComponent('animation-sequence', {
  schema: { entities: { type: 'array' } },

  init() {
    this.ents = this.data.entities.map(sel => document.querySelector(sel))
    this.currentIndex = 0
    this.sequenceStarted = false
    this.sequenceCompleted = false
    this._onAnimFinished = null

    const scene = this.el.sceneEl
    scene.addEventListener('loaded', () => this.setupSequence())
  },

  setupSequence() {
    const id = new URLSearchParams(window.location.search).get('id')

    const targetMap = {
      1: 'chocos1',
      2: 'moons_stars',
      3: 'doet',
      4: 'chhota_laddoo',
      5: 'crunchy_bites',
    }
    const showTarget = targetMap[id]

    document.querySelectorAll('xrextras-named-image-target').forEach(t => {
      t.setAttribute('enabled', false)
      t.style.display = 'none'
    })

    const targetEl = document.querySelector(`xrextras-named-image-target[name="${showTarget}"]`)
    if (showTarget && targetEl) {
      document.getElementById(showTarget).style.display = 'block'
      targetEl.setAttribute('enabled', true)
    }

    const uiscreen = document.getElementById('ui-screen')
    const scene = this.el.sceneEl

    const onFound = () => {
      console.log('ðŸŸ¢ Image found!')
      if (uiscreen) {
        uiscreen.style.opacity = '0'
        setTimeout(() => uiscreen.style.display = 'none', 300)
      }
      if (!this.sequenceStarted) {
        this.sequenceStarted = true
        this.chainAnimations()
      } else if (!this.sequenceCompleted) {
        this.resumeAll()
      }
    }

    const onLost = () => {
      console.log('â¸ï¸ Image lost.')
      if (uiscreen) {
        uiscreen.style.display = 'flex'
        setTimeout(() => uiscreen.style.opacity = '1', 10)
      }
      if (!this.sequenceCompleted) this.pauseAll()
    }

    if (targetEl) {
      targetEl.addEventListener('xrimagefound', onFound)
      targetEl.addEventListener('xrimagelost', onLost)
    }

    scene.addEventListener('xrimagefound', onFound)
    scene.addEventListener('xrimagelost', onLost)
  },

 playEntity(index) {
    // Hide all, show only current
    this.ents.forEach((e, i) => e.setAttribute('visible', i === index))
    const entity = this.ents[index]
    if (!entity) return

    const onModelLoaded = () => {
      const mixerComp = entity.components['animation-mixer']
      if (mixerComp && mixerComp.mixer) {
        const {mixer} = mixerComp
        mixer.stopAllAction()
        mixer.timeScale = 1

        // Start first clip
        const actions = Object.values(mixer._actions)
        if (actions.length > 0) {
          const action = actions[0]
          action.reset().play()
          console.log(`ðŸŽ¥ Playing animation ${index + 1}`)
        } else {
          console.warn(`âš ï¸ No animation clips found in ${entity.id}`)
        }
      } else {
        console.warn(`âš ï¸ No animation-mixer on ${entity.id}`)
      }
    }

    if (entity.hasLoaded) onModelLoaded()
    else entity.addEventListener('model-loaded', onModelLoaded, {once: true})
  },

  pauseAll() {
    this.ents.forEach((e) => {
      const m = e.components['animation-mixer']
      if (m && m.mixer) m.mixer.timeScale = 0
    })
    console.log('â¸ï¸ Animations paused.')
  },

  resumeAll() {
    this.ents.forEach((e) => {
      const m = e.components['animation-mixer']
      if (m && m.mixer) m.mixer.timeScale = 1
    })
    console.log('â–¶ï¸ Animations resumed.')
  },

  chainAnimations() {
    if (this.sequenceCompleted) return

    const current = this.ents[this.currentIndex]
    const comp = current.components['animation-mixer']
    if (!comp || !comp.mixer) {
      console.warn(`âš ï¸ No mixer found on entity ${current.id}`)
      return
    }

    const {mixer} = comp

    // Remove any old listener
    if (this._onAnimFinished) mixer.removeEventListener('finished', this._onAnimFinished)

    // New finish handler
    this._onAnimFinished = () => {
      this.currentIndex++
      if (this.currentIndex < this.ents.length) {
        console.log(`âž¡ï¸ Moving to animation ${this.currentIndex + 1}`)
        this.playEntity(this.currentIndex)
        this.chainAnimations()
      } else {
        this.sequenceCompleted = true
        console.log('ðŸ All animations finished successfully!')
      }
    }

    mixer.addEventListener('finished', this._onAnimFinished)

    // Play current
    this.playEntity(this.currentIndex)
  },
})
    </script>

  </body>
</html>
