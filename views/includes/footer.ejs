<script>
AFRAME.registerComponent('animation-sequence', {
  schema: {
    entities: {type: 'array'},
  },

  init() {
    // Cache entity references
    this.ents = this.data.entities.map(sel => document.querySelector(sel))
    this.currentIndex = 0
    this.sequenceStarted = false
    this.sequenceCompleted = false
    this._onAnimFinished = null

    const scene = this.el.sceneEl
    scene.addEventListener('loaded', () => {
      console.log('ðŸŽ¬ Scene fully loaded.')
      this.setupSequence()
    })
  },

  // setupSequence() {
  //   const id = new URLSearchParams(window.location.search).get('id')

  //   // Map URL â†’ target name
  //   const targetMap = {
  //     1: 'chocos1',
  //     2: 'moons_stars',
  //     3: 'doet',
  //     4: 'chhota_laddoo',
  //     5: 'crunchy_bites',
  //   }
  //   const showTarget = targetMap[id]
  //   document.querySelectorAll('xrextras-named-image-target').forEach((t) => {
  //     t.setAttribute('enabled', false)
  //     t.style.display = 'none'
  //   })
  //   const targetEll = document.querySelector(
  //     `xrextras-named-image-target[name="${showTarget}"]`
  //   )
  //   document.querySelectorAll('[animation-sequence]').forEach((seq) => {
  //     const parent = seq.closest('xrextras-named-image-target')
  //     if (!parent || parent.id !== showTarget) {
  //       seq.setAttribute('animation-sequence', 'enabled: false')
  //     }
  //   })

  //   if (showTarget) {
  //     document.getElementById(showTarget).style.display = 'block'
  //     targetEll.setAttribute('enabled', true)
  //     targetEll.setAttribute('name', showTarget)
  //     console.log('Showing:', showTarget)
  //   } else {
  //     console.log('Invalid URL ID, no target shown')
  //   }
  //   console.log('âœ… Animation sequence ready.')
  //   const uiscreen = document.getElementById('ui-screen')
  //   const imageTarget = this.el.closest('xrextras-named-image-target')
  //   const scene = this.el.sceneEl

  //   const onFound = () => {
  //     console.log('ðŸŸ¢ Image found!')
  //     uiscreen.style.transition = 'opacity 0.3s ease'
  //     uiscreen.style.opacity = '0'  // Fade out the overlay
  //     setTimeout(() => {
  //       uiscreen.style.display = 'none'  // Hide after fade
  //     }, 300)
  //     if (!this.sequenceStarted) {
  //       this.sequenceStarted = true
  //       this.chainAnimations()
  //     } else if (!this.sequenceCompleted) {
  //       this.resumeAll()
  //     }
  //   }

  //   const onLost = () => {
  //     console.log('â¸ï¸ Image lost.')
  //     uiscreen.style.display = 'flex'  // Show overlay
  //     setTimeout(() => {
  //       uiscreen.style.transition = 'opacity 0.3s ease'
  //       uiscreen.style.opacity = '1'  // Fade in the overlay
  //     }, 10)
  //     if (!this.sequenceCompleted) this.pauseAll()
  //   }

  //   // Listen on both the target + scene (for safety)
  //   if (imageTarget) {
  //     imageTarget.addEventListener('xrimagefound', onFound)
  //     imageTarget.addEventListener('xrimagelost', onLost)
  //     console.log('ðŸ”— Bound listeners to xrextras-named-image-target.')
  //   }
  //   scene.addEventListener('xrimagefound', onFound)
  //   scene.addEventListener('xrimagelost', onLost)
  // },

  setupSequence() {
  // ðŸ”¥ Read target from URL path ( /chocos1 )
  const showTarget = window.location.pathname.replace('/', '')

  const validTargets = [
    'chocos1',
    'moons_stars',
    'doet',
    'chhota_laddoo',
    'crunchy_bites',
  ]

  
  
  
  if (!showTarget) {
  console.error("âŒ Target not found in URL");
} else if (!validTargets.includes(showTarget)) {
  console.error("âŒ Invalid target:", showTarget);
} else {
  console.log("âœ… Valid Target:", showTarget);

  // SHOW IMAGE
  const imgEl = document.getElementById("target-img");
  if (imgEl) {
    imgEl.src = `/assets/images/targets/${showTarget}.png`; // change png/jpg as needed
  }
}
  // Hide all targets
  document.querySelectorAll('xrextras-named-image-target').forEach((t) => {
    t.setAttribute('enabled', false)
    t.style.display = 'none'
  })

  // Disable animation sequences for other targets
  document.querySelectorAll('[animation-sequence]').forEach((seq) => {
    const parent = seq.closest('xrextras-named-image-target')
    if (!parent || parent.id !== showTarget) {
      seq.setAttribute('animation-sequence', 'enabled: false')
    }
  })

  // Enable only matched target
  if (validTargets.includes(showTarget)) {
    const targetEl = document.getElementById(showTarget)
    if (targetEl) {
      targetEl.style.display = 'block'
      targetEl.setAttribute('enabled', true)
      console.log('ðŸŽ¯ Showing target:', showTarget)
    }
  } else {
    console.warn('âŒ Invalid URL target:', showTarget)
  }

  console.log('âœ… Animation sequence ready.')

  const uiscreen = document.getElementById('ui-screen')
  const imageTarget = this.el.closest('xrextras-named-image-target')
  const scene = this.el.sceneEl

  const onFound = () => {
    console.log('ðŸŸ¢ Image found!')
    uiscreen.style.transition = 'opacity 0.3s ease'
    uiscreen.style.opacity = '0'
    setTimeout(() => {
      uiscreen.style.display = 'none'
    }, 300)

    if (!this.sequenceStarted) {
      this.sequenceStarted = true
      this.chainAnimations()
    } else if (!this.sequenceCompleted) {
      this.resumeAll()
    }
  }

  const onLost = () => {
    console.log('â¸ï¸ Image lost.')
    uiscreen.style.display = 'flex'
    setTimeout(() => {
      uiscreen.style.transition = 'opacity 0.3s ease'
      uiscreen.style.opacity = '1'
    }, 10)

    if (!this.sequenceCompleted) this.pauseAll()
  }

  if (imageTarget) {
    imageTarget.addEventListener('xrimagefound', onFound)
    imageTarget.addEventListener('xrimagelost', onLost)
  }

  scene.addEventListener('xrimagefound', onFound)
  scene.addEventListener('xrimagelost', onLost)
},

  playEntity(index) {
    // Hide all, show only current
    this.ents.forEach((e, i) => e.setAttribute('visible', i === index))
    const entity = this.ents[index]
    if (!entity) return


      // â­ SHOW ELEMENT WHEN INDEX = 2
  if (index === 2) {  
    const specialElement = document.querySelector(".yellow-card");
    if (specialElement) {
      specialElement.style.display = "block";
      console.log("ðŸŽ‰ Display block activated at animation index 2");
    }
  }

  

    const onModelLoaded = () => {
      const mixerComp = entity.components['animation-mixer']
      if (mixerComp && mixerComp.mixer) {
        const {mixer} = mixerComp
        mixer.stopAllAction()
        mixer.timeScale = 1

        // Start first clip
        const actions = Object.values(mixer._actions)
        if (actions.length > 0) {
          const action = actions[0]
          action.reset().play()
          console.log(`ðŸŽ¥ Playing animation ${index + 1}`)
        } else {
          console.warn(`âš ï¸ No animation clips found in ${entity.id}`)
        }
      } else {
        console.warn(`âš ï¸ No animation-mixer on ${entity.id}`)
      }
    }

    if (entity.hasLoaded) onModelLoaded()
    else entity.addEventListener('model-loaded', onModelLoaded, {once: true})
  },

  pauseAll() {
    this.ents.forEach((e) => {
      const m = e.components['animation-mixer']
      if (m && m.mixer) m.mixer.timeScale = 0
    })
    console.log('â¸ï¸ Animations paused.')
  },

  resumeAll() {
    this.ents.forEach((e) => {
      const m = e.components['animation-mixer']
      if (m && m.mixer) m.mixer.timeScale = 1
    })
    console.log('â–¶ï¸ Animations resumed.')
  },

  chainAnimations() {
    if (this.sequenceCompleted) return

    const current = this.ents[this.currentIndex]
    const comp = current.components['animation-mixer']
    if (!comp || !comp.mixer) {
      console.warn(`âš ï¸ No mixer found on entity ${current.id}`)
      return
    }

    const {mixer} = comp

    // Remove any old listener
    if (this._onAnimFinished) mixer.removeEventListener('finished', this._onAnimFinished)

    // New finish handler
    this._onAnimFinished = () => {
      this.currentIndex++
      if (this.currentIndex < this.ents.length) {
        console.log(`âž¡ï¸ Moving to animation ${this.currentIndex + 1}`)
        this.playEntity(this.currentIndex)
        this.chainAnimations()
      } else {
        this.sequenceCompleted = true
        console.log('ðŸ All animations finished successfully!')
      }
    }

    mixer.addEventListener('finished', this._onAnimFinished)

    // Play current
    this.playEntity(this.currentIndex)
  },
})


    </script>
<script src="/main-bundled.js"></script>
 
</body>

</html>